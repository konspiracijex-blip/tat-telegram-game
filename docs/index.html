<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAT TEST</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Telegram Theme Variables */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #777777);
            --tg-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* CRNA POZADINA ZA CELU IGRU */
            background-color: #000000; 
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 600px;
            padding: 20px 0;
            text-align: center;
        }

        #quiz-image {
            width: 100%;
            max-height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #question-text {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 25px;
            color: var(--tg-text);
            text-align: left;
            width: 100%;
        }

        /* STIL ZA POLJA ODGOVORA (CRNA POZADINA, BELI OUTLINE) */
        .option-button {
            background-color: #000000; 
            color: var(--tg-text); 
            border: 1px solid #FFFFFF; /* Beli outline */
            padding: 12px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.1s;
        }

        .option-button:hover {
             background-color: var(--tg-secondary-bg);
        }
        
        /* STIL ZA GLAVNE TASTERE (POKRENI TEST, KRAJ) */
        .main-button {
            background-color: #000000; /* Crna */
            color: #FFFFFF; /* Beli tekst */
            
            border: 1px solid #FFFFFF; /* Beli outline */
            
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            margin-top: 30px;
        }

        #start-screen, #quiz-screen, #end-screen, #timeout-screen {
            display: none;
            width: 100%;
            text-align: left; 
        }
        
        #end-screen h2 {
            text-align: center;
            color: var(--tg-button-color);
            margin-bottom: 20px;
        }
        
        #end-screen p {
            margin-bottom: 15px;
            line-height: 1.5;
            padding: 0 5px;
        }
        
        #additional-text-container {
             text-align: left;
             margin-top: 30px; 
             padding: 20px 0; 
             border-top: 1px solid var(--tg-hint);
        }

        /* STIL ZA TAJMER LINIJU */
        #timer-line {
            width: 100%;
            height: 2px; /* 2 piksela debela */
            background-color: red; /* Crvena boja */
            margin-bottom: 25px; /* Razmak ispod linije */
        }

        /* STIL ZA EKRAN ISTEKLOG VREMENA */
        #timeout-screen {
            display: none;
            width: 100%;
            text-align: center;
            padding-top: 50px;
        }

        #timeout-screen h1 {
            color: var(--tg-text);
            margin-bottom: 20px; 
            font-size: 1.6em; 
        }
        #timeout-screen p {
            color: red;
            font-size: 1.6em; 
            font-weight: bold;
            margin-bottom: 40px;
            margin-top: 0; 
        }

        #progress-bar {
            width: 100%;
            background-color: var(--tg-secondary-bg);
            border-radius: 4px;
            margin-bottom: 20px;
            height: 8px;
        }

        #progress-fill {
            height: 8px;
            background-color: var(--tg-button-color);
            width: 0%;
            border-radius: 4px;
            transition: width 0.3s;
        }

    </style>
</head>
<body>

<div class="container">
    <div id="progress-bar"><div id="progress-fill"></div></div>

    <div id="start-screen">
        <h1 style="text-align: center; font-size: 1.6em;">Tematski Appercepcioni Test</h1>
        <p style="text-align: left; margin-bottom: 25px; color: var(--tg-text);">
            Svet koji poznaješ nije onakav kakvim ti ga prikazuju.
            <br><br>
            Iza svake odluke, svake reči, svakog pogleda - krije se odraz tebe samog.
            <br>Ova igra nije običan test.
            <br>Nema tačnih odgovora, samo istiniti odrazi.
            <br>Na osnovu tvojih izbora, otkriće se ko si - i koliko duboko vidiš.
        </p>
        <p style="text-align: left; font-size: 0.9em; margin-bottom: 30px; color: var(--tg-text);">
            Test se zasniva na stvarnom Tematskom appercepcionom testu (TAT), korišćenom u vojnim i obaveštajnim psihološkim procenama. Svaka slika koju vidiš nosi simboliku, a svaki odgovor meri ono što ne možeš sakriti - način na koji gledaš svet.
            <br><br>
            Pazi šta biraš. Sistem pamti...
        </p>
        <button id="startButton" class="main-button" onclick="startQuiz()">
            POKRENI TEST
        </button>
    </div>

    <div id="quiz-screen">
        <img id="quiz-image" src="" alt="TAT Image">
        
        <div id="timer-line"></div> 
        
        <p id="question-text"></p>
        <div id="options-container">
            </div>
    </div>

    <div id="end-screen">
        <h1 style="text-align: center;">Test Završen!</h1>
        <h2 id="profile-name"></h2>
        <p id="profile-procena" style="font-style: italic;"></p>
        <p id="profile-opis"></p>
        
        <div id="additional-text-container" style="display:none; margin-top: 30px; padding: 20px 0; border-top: 1px solid var(--tg-hint);">
            <p id="additional-text-content" style="font-size: 0.95em;"></p>
        </div>

        <button id="additionalButton" class="main-button" onclick="showAdditionalText()">
            DODATAK
        </button>
    </div>

    <div id="timeout-screen">
        <h1>VREME ZA ODGOVOR JE ISTEKLO</h1>
        <p>NISTE PROŠLI TEST</p>
        <button id="restartButton" class="main-button" onclick="startQuiz()">
            POKRENI TEST
        </button>
    </div>
</div>

<script>
    Telegram.WebApp.ready();
    Telegram.WebApp.setHeaderColor('secondary_bg_color'); 

    // GLOBALNE VARIJABLE ZA TAJMER
    const TIME_LIMIT = 40000; // 40 sekundi
    let timerId = null; 

    // Pitanja i Bodovi
    const QUESTIONS_DATA = {
        1: {
            "image_path": "https://i.postimg.cc/Xv3QTq0W/image-01.jpg",
            "text": "*Šta se ovde dešava?*",
            "full_options": {
                "A": "Muškarac analizira tajni dokument. Deluje kao islednik.",
                "B": "On gleda u nešto što ga plaši. Možda je otkrio istinu koju nije smeo da vidi.",
                "C": "To je naučnik koji proučava dokaz o postojanju nečeg nadprirodnog.",
                "D": "Čovek je sam sa sobom. Papir ispred njega je samo izgovor.",
            },
            "points": {"A": 2, "B": 3, "C": 4, "D": 5,}
        },
        2: {
            "image_path": "https://i.postimg.cc/nzVdXvBq/image-02.jpg",
            "text": "*Šta vidiš na ovoj slici?*",
            "full_options": {
                "A": "Žena čeka nekoga. Možda prijatelja.",
                "B": "Neko je posmatra iz senke. Oseća da nije sama.",
                "C": "Između njih postoji nevidiva veza – kao da se prepoznaju i bez reči.",
                "D": "To nije susret – to je ogledalo. Ona vidi sebe u tami.",
            },
            "points": {"A": 1, "B": 3, "C": 4, "D": 5,}
        },
        3: {
            "image_path": "https://i.postimg.cc/76trgbfM/image-03.jpg",
            "text": "*Šta se ovde upravo dogodilo?*",
            "full_options": {
                "A": "Neko je naglo otišao. Posvađali su se.",
                "B": "Pismo na stolu sadrži istinu koju je neko dugo krio.",
                "C": "Ovo je trenutak posle priznanja. Tišina između dvoje ljudi postala je nepodnošljiva.",
                "D": "Nikoga ovde nije bilo. Sve je samo sećanje koje soba pamti.",
            },
            "points": {"A": 2, "B": 3, "C": 4, "D": 5,}
        },
        4: {
            "image_path": "https://i.postimg.cc/VsRP9Gb9/image-04.jpg",
            "text": "*Šta misliš da se dešava?*",
            "full_options": {
                "A": "On ulazi, spreman da se suoči s onim što ga čeka.",
                "B": "On zatvara vrata za sobom, zauvek.",
                "C": "Okleva, jer zna da odluka menja sve.",
                "D": "Vrata ne vode nigde – to su vrata njegovog uma.",
            },
            "points": {"A": 3, "B": 2, "C": 1, "D": 4,}
        },
        5: {
            "image_path": "https://i.postimg.cc/fRZ0H4mG/image-05.jpg",
            "text": "*Šta sada zna?*",
            "full_options": {
                "A": "Shvata da je sve bilo laž.",
                "B": "Razume da je i sam deo onoga što je pokušavao da otkrije.",
                "C": "Konačno dobija potvrdu da je bio u pravu.",
                "D": "Nije siguran u ono što vidi – možda to uopšte nije istina.",
            },
            "points": {"A": 3, "B": 4, "C": 2, "D": 1,}
        },
        6: {
            "image_path": "https://i.postimg.cc/C5k49W7t/image-06.jpg", 
            "text": "*Šta će sada uraditi?*",
            "full_options": {
                "A": "Odlazi zauvek, ne osvrće se.",
                "B": "Pali dokument i okreće se novom početku.",
                "C": "Stoji u tišini, jer zna da nema povratka.",
                "D": "Vraća se tamo odakle je sve počelo.",
            },
            "points": {"A": 2, "B": 3, "C": 1, "D": 4,}
        },
        7: {
            "image_path": "https://i.postimg.cc/Zn8M69Gn/image-07.jpg",
            "text": "*Koga vidi u ogledalu?*",
            "full_options": {
                "A": "Sebe, ali drugačijeg nego ranije.",
                "B": "Osobu koja ga je izdala.",
                "C": "Nekog koga ne poznaje.",
                "D": "Nikoga – ogledalo je prazno.",
            },
            "points": {"A": 3, "B": 2, "C": 4, "D": 1,}
        },
        8: {
            "image_path": "https://i.postimg.cc/MH0zXpd2/image-08.jpg",
            "text": "*Šta sada misli o svetu?*",
            "full_options": {
                "A": "Svet je samo sistem koji jede sopstvenu decu.",
                "B": "Svet je haotičan, ali u haosu ima istine.",
                "C": "Svet je uvek bio takav – mi smo se promenili.",
                "D": "Svet je spašen ako se pojedinac promeni.",
            },
            "points": {"A": 3, "B": 4, "C": 2, "D": 1,}
        },
        9: {
            "image_path": "https://i.postimg.cc/L4Gy8VZN/image-09.jpg",
            "text": "*Kome će pripasti?*",
            "full_options": {
                // ✅ ISPRAVLJENO: "kto" u "ko"
                "A": "Onome ko drži istinu, makar bila bolna.",
                "B": "Onome ko ima moć da održi red.",
                "C": "Nikome – put istine je usamljen.",
                "D": "Onome ko ćuti, jer samo tihi prežive.",
            },
            "points": {"A": 4, "B": 2, "C": 3, "D": 1,}
        },
        10: {
            "image_path": "https://i.postimg.cc/QMrGK392/image-10.jpg",
            "text": "*Šta nosi sa sobom?*",
            "full_options": {
                "A": "Ništa – jer sve što treba, izgubljeno je.",
                "B": "Svoje misli – jedino što niko ne može uzeti.",
                "C": "Istinu – čak i ako je niko ne želi čuti.",
                "D": "Tišinu – jer samo ona razume ono što je bilo.",
            },
            "points": {"A": 1, "B": 3, "C": 4, "D": 2,}
        }
    };

    const SCORE_PROFILES = [
        {
            range: [10, 17],
            name: "Prilagođeni",
            title: "deo sistema koji održava iluziju reda",
            procena: "Svet za tebe funkcioniše onako kako treba.\nVidiš red tamo gde drugi vide zidove.\nVeruješ da sistem postoji da bi štitio ljude, ne da bi ih kontrolisao. Tvoje poverenje daje mu snagu. Ipak… Iza svetla koje poznaješ postoji senka koju ne primećuješ. Možda si bezbedan — ali nisi slobodan.",
            opis: "Prilagođeni su temelji svake strukture. Oni su oni koji veruju, poštuju pravila i ne preispituju autoritet. Njihov svet se zasniva na uverenju da je red isto što i istina, i da haos dolazi od onih koji “previše sumnjaju”. Ovi ljudi su često moralni, pouzdani i lojalni. Ali njihova snaga je ujedno i njihova slabost — veruju da je mir važniji od slobode. U kriznim situacijama slede naredbe. Ne pitaju zašto, već kako. Ako dođe dan kada sistem zatraži njihovu poslušnost protiv drugih — oni će poslušati. Ne iz zlobe, već iz uverenja da “tako treba”."
        },
        {
            range: [18, 24],
            name: "Sumnjičavi",
            title: "onaj koji se budi, ali još uvek drži oči zatvorene",
            procena: "U tebi se bore dve strane — poverenje i sumnja.\nOsećaš da nešto nije u redu, ali još uvek tražiš dokaz, znak, istinu. Sistem te ne plaši, ali ni ne uverava. Ti si posmatrač koji čeka trenutak da odluči na koju će stranu. Nisi izgubljen — samo još nisi spreman da progledaš. Ako dođe dan kada sistem zatraži njihovu poslušnost protiv drugih — oni će poslušati. Ne iz zlobe, već iz uverenja da “tako treba”.",
            opis: "Sumnjičavi su prelazna faza između poslušnosti i svesnosti. To su ljudi koji počinju da osećaju neusklađenost između onoga što im se govori i onoga što vide. Oni ne veruju slepo — ali još uvek se plaše da poveruju sebi. U njima se javlja nemir, tihi glas koji ih upozorava da svet nije onakav kakvim se čini. Ipak, sumnja je za njih težak teret, jer znači da moraju da preuzmu odgovornost. U kriznim trenucima deluju neodlučno, posmatraju pre nego što reaguju. Oni su na ivici buđenja — i sistem to zna. Zato ih ne napada, već im nudi iluziju izbora. Sumnjičavi su uvek na ivici — između onoga što jesu i onoga što mogu postati."
        },
        {
            range: [25, 32],
            name: "Otporni",
            title: "onaj koji više ne pristaje",
            procena: "Ti ne prihvataš svet kakav ti je dat.\nSumnjaš, preispituješ, tražiš. Istina ti je važnija od mira, sloboda vrednija od sigurnosti. Sistem te vidi kao pretnju, jer ti vidiš ono što drugi ne žele da vide. I kad ćutiš, tvoje ćutanje odzvana kao otpor.",
            opis: "Otporni su oni koji su se probudili, ali još uvek nisu u ratu. Oni razumeju da svet kojim upravlja sistem nije slučajnost — već konstrukcija. Njihova intuicija je snažna, njihova moralna osećanja duboka. Ne traže konflikte, ali ne beže od istine. U kriznim trenucima, oni se oslanjaju na unutrašnju logiku, ne na autoritet. Njihove odluke su ponekad teške, ali uvek svesne. Sistem ih često posmatra, testira, pokušava da ih slomi kroz sumnju i izolaciju. Ali oni opstaju. Otporni su oni koji prepoznaju zabludu — i znaju da istina uvek ima cenu. I spremni su da je plate."
        },
        {
            range: [33, 40],
            name: "Vizionar",
            title: "nosilac plamena koji tek dolazi",
            procena: "Ti ne samo da vidiš istinu — ti je osećaš.\nNe tražiš da se svet promeni. Ti si taj koji menja svet. Sistem te se ne plaši zbog onoga što znaš, već zbog onoga što možeš da pokreneš. Tvoje misli su ispred vremena, a tvoj pogled ne pripada ovom svetu.",
            opis: "Vizionari su oni koji ne samo da su svesni — već i deluju. Njihov um funkcioniše kao most između sadašnjosti i onoga što dolazi. Oni ne traže potvrdu, jer znaju da istina ne zahteva saglasnost. Njihova percepcija je šira — vide obrasce, strukture i nevidljive niti koje povezuju događaje. U kriznim situacijama ostaju smireni, jer znaju da je haos samo prelazna faza. Oni ne reaguju — oni predviđaju. Sistem ih prepoznaje kao anomalije. Pokušava da ih ućutka, da ih predstavi kao fanatike, da ih izoluje. Ali vizionar zna da je svaka promena prvo bila jeres.\\nOni su svetlost u tami — i tama to zna."
        }
    ];


    // Globalne varijable stanja
    let currentQuestionNum = 0;
    let totalScore = 0;
    const TOTAL_QUESTIONS = Object.keys(QUESTIONS_DATA).length;
    
    function showScreen(screenId) {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'none';
        document.getElementById('end-screen').style.display = 'none';
        document.getElementById('timeout-screen').style.display = 'none'; 
        document.getElementById(screenId).style.display = 'block';
    }

    function updateProgress() {
        const progress = (currentQuestionNum / TOTAL_QUESTIONS) * 100;
        document.getElementById('progress-fill').style.width = progress + '%';
        document.getElementById('progress-bar').style.display = currentQuestionNum > 0 && currentQuestionNum <= TOTAL_QUESTIONS ? 'block' : 'none';
    }

    /* -------------------------------------------------------------------------- */
    /* TAJMER LOGIKA                              */
    /* -------------------------------------------------------------------------- */
    
    // Funkcija koja se poziva kada vreme istekne
    function handleTimeout() {
        if (timerId) {
            clearTimeout(timerId);
            timerId = null;
        }
        
        document.getElementById('progress-bar').style.display = 'none';
        showScreen('timeout-screen');
    }
    
    // Funkcija koja pokreće vizuelni tajmer
    function startTimer() {
        // Resetovanje prethodnog tajmera
        if (timerId) {
            clearTimeout(timerId);
        }

        const timerLine = document.getElementById('timer-line');
        // 1. Resetujemo širinu na 100% i isključujemo tranziciju za brzi reset
        timerLine.style.transition = 'none';
        timerLine.style.width = '100%'; 
        
        // Prinudno reflow-ovanje da se reset vizuelno primeni
        // eslint-disable-next-line no-unused-expressions
        timerLine.offsetHeight; 
        
        // 2. Pokrećemo tranziciju na 40 sekundi ka 0% širine
        timerLine.style.transition = `width ${TIME_LIMIT / 1000}s linear`;
        timerLine.style.width = '0%'; 
        
        // 3. Postavljanje timeout-a
        timerId = setTimeout(handleTimeout, TIME_LIMIT);
    }
    /* -------------------------------------------------------------------------- */


    function startQuiz() {
        currentQuestionNum = 1;
        totalScore = 0;
        showScreen('quiz-screen');
        document.getElementById('progress-bar').style.display = 'block'; 
        displayQuestion(currentQuestionNum);
    }

    function displayQuestion(qNum) {
        if (qNum > TOTAL_QUESTIONS) {
            return endQuiz();
        }

        startTimer(); 
        
        const data = QUESTIONS_DATA[qNum];
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = ''; 
        
        // Uklonjen tekst "Pitanje X/10"
        document.getElementById('question-text').innerHTML = `${data.text.replace(/\*/g, '')}`; 
        
        document.getElementById('quiz-image').src = data.image_path;
        
        let optionsHtml = '';
        for (const [key, text] of Object.entries(data.full_options)) {
            optionsHtml += `<button class="option-button" data-key="${key}" onclick="handleAnswer('${key}', ${qNum})">**${key}:** ${text}</button>`;
        }
        optionsContainer.innerHTML = optionsHtml;

        updateProgress();
    }

    function handleAnswer(answerKey, qNum) {
        // OBAVEZNO BRISANJE TAJMERA
        if (timerId) {
            clearTimeout(timerId);
            timerId = null;
        }
        
        const questionData = QUESTIONS_DATA[qNum];
        
        const points = questionData.points[answerKey];
        totalScore += points;
        
        currentQuestionNum++;
        displayQuestion(currentQuestionNum);
    }

    function getProfileByScore(score) {
        score = Math.max(10, Math.min(40, score));
        for (const profile of SCORE_PROFILES) {
            if (score >= profile.range[0] && score <= profile.range[1]) {
                return profile;
            }
        }
        return null;
    }

    function displayProfile(score) {
        const profileData = getProfileByScore(score);
        
        if (profileData) {
            document.getElementById('profile-name').textContent = `PROFIL ${profileData.name.toUpperCase()} - ${profileData.title}`;
            document.getElementById('profile-procena').innerHTML = `**PROCENA:**<br>${profileData.procena.replace(/\n/g, '<br>')}`;
            document.getElementById('profile-opis').innerHTML = `**OPIS:**<br>${profileData.opis.replace(/\n/g, '<br>')}`;
        } else {
            document.getElementById('profile-name').textContent = "Greška pri pronalaženju profila";
            document.getElementById('profile-procena').textContent = "";
            document.getElementById('profile-opis').textContent = "";
        }
    }

    function endQuiz() {
        // Obavezno brisanje tajmera pre kraja
        if (timerId) {
            clearTimeout(timerId);
            timerId = null;
        }

        displayProfile(totalScore);
        showScreen('end-screen');
        updateProgress(); 
        Telegram.WebApp.MainButton.hide(); 
    }

    function sendFinalScore() {
        const dataToSend = {
            "action": "final_score",
            "score": totalScore.toString() 
        };
        
        const jsonString = JSON.stringify(dataToSend);
        Telegram.WebApp.sendData(jsonString); 
    }
    
    function showAdditionalText() {
        const endScreen = document.getElementById('end-screen');
        const container = document.getElementById('additional-text-container');
        const content = document.getElementById('additional-text-content');
        const button = document.getElementById('additionalButton');

        const text = `
            Svako ogledalo pokazuje ono što već postoji u nama.<br><br>
            Nema boljih i gorih, samo onih koji su spremni da vide - i onih koji još uvek uče da gledaju.<br>
            Tvoj izbor, tvoje reči i tvoja tišina oblikuju svet više nego što misliš.<br>
            U vremenu koje dolazi, biće potrebni i oni koji sumnjaju, i oni koji veruju, i oni koji se bore.<br><br>
            Jer istina se ne rađa iz sile - već iz svesti.<br>
            Svet se menja kada se promene oni koji ga nose.<br>
            I zato - ne plaši se onoga što si video.<br><br>
            Plaši se onoga što bi moglo ostati neviđeno.
        `;
        
        const channelLink = `
            <br><br>
            Kanal “<a href="https://t.me/konspiracije" target="_blank" style="color: var(--tg-button-color); text-decoration: none;">Konspiracije</a>” nastavlja da traži one koji gledaju dublje.
        `;

        if (container.style.display === 'none') {
            
            // BRISANJE PRETHODNOG PROFILNOG SADRŽAJA
            document.getElementById('profile-name').style.display = 'none';
            document.getElementById('profile-procena').style.display = 'none';
            document.getElementById('profile-opis').style.display = 'none';
            endScreen.querySelector('h1').style.display = 'none'; 

            // Prikazujemo dodatni tekst
            content.innerHTML = text + channelLink;
            container.style.display = 'block';
            
            // Promena teksta dugmeta u "KRAJ"
            button.textContent = "KRAJ"; 
            
            // Re-definišemo akciju dugmeta na slanje podataka i zatvaranje App-a
            button.onclick = () => {
                sendFinalScore();
                Telegram.WebApp.close(); 
            };
        } else {
            // Ako se pritisne 'KRAJ', šaljemo podatke i zatvaramo App
            sendFinalScore();
            Telegram.WebApp.close(); 
        }
    }
    
    // Prikazuje početni ekran pri učitavanju
    showScreen('start-screen');
    updateProgress();
</script>
</body>
</html>
